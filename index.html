<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>宝探し（A-Frame・視線で回収・スマホVR対応）</title>
  <!-- A-Frame CDN -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <!-- 便利なアニメーション用コンポーネント（公式） -->
  <script src="https://cdn.jsdelivr.net/npm/aframe-animation-component@5.1.0/dist/aframe-animation-component.min.js"></script>
  <style>
    html, body { margin: 0; height: 100%; background: #000; }
  </style>
</head>
<body>
  <a-scene renderer="antialias: true" background="color: #CFE9FF">
    <!-- アセット管理 -->
    <a-assets>
      <audio id="ping" src="https://cdn.jsdelivr.net/gh/naptha/tinyfiles@master/audio/ui/confirm.wav"></audio>
      <img id="skyTex" src="https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?q=80&w=1920&auto=format&fit=crop" crossorigin="anonymous"/>
    </a-assets>

    <!-- 空と地面 -->
    <a-sky src="#skyTex"></a-sky>
    <a-plane position="0 0 0" rotation="-90 0 0" width="40" height="40" color="#A7E5C0" shadow="receive: true"></a-plane>

    <!-- 説明テキスト＆スコア表示 -->
    <a-entity id="ui" position="0 2 -1.2">
      <a-entity id="title" text="value: 宝探しへようこそ！; align: center; width: 3.5; color: #222;" position="0 0.35 0"></a-entity>
      <a-entity id="hint" text="value: ☆ 5コの宝ものを見つめて回収しよう！; align: center; width: 3.2; color: #333;"></a-entity>
      <a-entity id="score" text="value: 0 / 5; align: center; width: 3; color: #1a5d1a;" position="0 -0.35 0"></a-entity>
    </a-entity>

    <!-- カメラ＆視線カーソル（Cardboard向け：中心にリング。視線を1.2秒あてるとクリック=回収） -->
    <a-entity id="rig" position="0 1.6 0">
      <a-entity id="camera" camera look-controls>
        <a-entity id="cursor"
                  cursor="fuse: true; fuseTimeout: 1200"
                  position="0 0 -0.7"
                  geometry="primitive: ring; radiusInner: 0.01; radiusOuter: 0.015"
                  material="color: #ffffff; shader: flat; opacity: 0.9">
          <!-- 視線が当たっている間、カーソルを少し大きくするアニメ -->
          <a-animation begin="cursor-fusing" attribute="scale" dur="1200" from="1 1 1" to="1.5 1.5 1.5" fill="forwards"></a-animation>
          <a-animation begin="click" attribute="scale" dur="200" to="1 1 1"></a-animation>
        </a-entity>
      </a-entity>
    </a-entity>

    <!-- 宝物（トーラス：金色コイン風） -->
    <a-entity id="treasures"></a-entity>

    <!-- ちょっとした飾り（やさしい木） -->
    <a-cylinder position="-3 1 -6" radius="0.3" height="2" color="#8B5A2B"></a-cylinder>
    <a-sphere position="-3 2.5 -6" radius="1.2" color="#2EC4B6"></a-sphere>

    <!-- 成功メッセージ（最初は非表示） -->
    <a-entity id="congrats" visible="false" position="0 2 -2" animation__pop="property: scale; to: 1.2 1.2 1.2; dir: alternate; dur: 700; loop: true">
      <a-entity text="value: ぜんぶ見つけた！; align: center; width: 5; color: #e91e63"></a-entity>
    </a-entity>

    <!-- 影（軽量化のため最小限） -->
    <a-entity light="type: ambient; intensity: 0.9"></a-entity>
    <a-entity light="type: directional; intensity: 0.5" position="0 5 -5"></a-entity>

    <script>
      // ====== 収集用コンポーネント ======
      AFRAME.registerComponent('collectible', {
        schema: { index: {type: 'int'} },
        init: function () {
          const el = this.el;
          el.addEventListener('click', () => {
            if (!el.getAttribute('visible')) return;

            // サウンド再生
            const snd = document.querySelector('#ping');
            if (snd) { const a = new Audio(snd.getAttribute('src')); a.play().catch(()=>{}); }

            // 小さくなって消えるアニメーション
            el.setAttribute('animation__shrink', {
              property: 'scale', to: '0.01 0.01 0.01', dur: 300, easing: 'easeOutQuad'
            });
            setTimeout(() => {
              el.setAttribute('visible', false);
              updateScore();
            }, 320);
          });
        }
      });

      const TOTAL = 5;
      let found = 0;

      function updateScore() {
        found += 1;
        const score = document.querySelector('#score');
        score.setAttribute('text', 'value', `${found} / ${TOTAL}`);
        if (found >= TOTAL) {
          document.querySelector('#ui').setAttribute('visible', false);
          const c = document.querySelector('#congrats');
          c.setAttribute('visible', true);
        }
      }

      // ====== 宝物をランダム配置 ======
      function spawnTreasures() {
        const parent = document.querySelector('#treasures');
        const radius = 6; // プレイヤーの周囲半径
        for (let i = 0; i < TOTAL; i++) {
          const angle = (i / TOTAL) * Math.PI * 2 + (Math.random() * 0.6);
          const dist = radius + (Math.random() * 2 - 1); // 5〜7mくらい
          const x = Math.cos(angle) * dist;
          const z = -Math.sin(angle) * dist - 2; // やや前方に集める
          const y = 0.8 + Math.random() * 1.2; // 高さ0.8〜2.0m

          const coin = document.createElement('a-entity');
          coin.setAttribute('class', 'treasure');
          coin.setAttribute('position', `${x} ${y} ${z}`);
          coin.setAttribute('rotation', `0 ${Math.random()*360} 0`);

          // 金色コイン風（トーラス）
          coin.setAttribute('geometry', 'primitive: torus; radius: 0.35; radiusTubular: 0.08; arc: 360');
          coin.setAttribute('material', 'color: #FFC107; metalness: 0.4; roughness: 0.2');

          // くるくる回転
          coin.setAttribute('animation__spin', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');

          // 見つめたときに少し大きく
          coin.setAttribute('animation__hover', 'property: scale; startEvents: mouseenter; to: 1.2 1.2 1.2; dur: 200');
          coin.setAttribute('animation__unhover', 'property: scale; startEvents: mouseleave; to: 1 1 1; dur: 200');

          coin.setAttribute('collectible', `index: ${i}`);
          parent.appendChild(coin);
        }
      }

      spawnTreasures();
    </script>
  </a-scene>
</body>
</html>
