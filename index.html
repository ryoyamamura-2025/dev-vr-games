<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>VR森の星探しゲーム</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
  <style>
    body {
      margin: 0;
      background: #87CEEB;
      font-family: system-ui, sans-serif;
    }
    
    .hud {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
      padding: 15px;
      color: #2F4F2F;
      text-align: center;
      pointer-events: none;
      background: rgba(255,255,255,0.9);
      font-size: 16px;
    }
    
    .vr-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      background: #FF6B6B;
      color: white;
      padding: 15px 30px;
      border: none;
      border-radius: 25px;
      font-size: 16px;
      font-weight: bold;
      cursor: pointer;
      pointer-events: all;
    }
    
    .vr-button:hover {
      background: #FF5252;
    }
  </style>
</head>
<body>
  <div class="hud">
    🌟 森の中の星を見つけよう！中央の丸で狙って見つめる（またはクリック）で回収できるよ
  </div>
  
  <button class="vr-button" onclick="enterVRMode()">🥽 VRモードで遊ぶ</button>

  <a-scene renderer="colorManagement: true; physicallyCorrectLights: true" background="color: #87CEEB">
    <!-- アセット -->
    <a-assets>
      <audio id="star-sound" src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmIbBzeVyOzNdykFJH/A6NyRQAoUYK7q5KJTFT1Dv+z5sGAaFzKS2OnIdiYGOoO87NOFOAgbYLTm47NUFApGntjxvF4aFzGQ1O/JdCUFN4K+8N2SQw8VPa/u7qBBFA1A0PTYx3krFz6S2ezXZDEPJ4G47+CdQBA4k9j94qtjGBIEruPmn1MKFi/D9NuJLQMgLKjz2plJGwMw0fDXik8DCy+59+OJKQAFp/z1lnH/C0HN7N6HPgAAp+Xdz58AAAAAAAAAAAAAAAlhZmZwAAAAAAAAAAAAAAAAAAAAAgAAACtaVGmwAABYWnQpAAAAAADY2thOAAAAWFp0NQAAAAC4uLhOAQAAWFp0IQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0KQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0KQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0KQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAACY2thOAAAAWFp0HQAAAAC4uLhOAAAAWFp0JQAAAABY2thOAAAAWFp0HQAAAAC4uLhOaaaaa" preload="auto"></audio>
    </a-assets>

    <!-- ライティング -->
    <a-entity light="type: ambient; intensity: 0.6; color: #ffffff"></a-entity>
    <a-entity light="type: directional; intensity: 0.8; castShadow: true" position="5 10 5"></a-entity>

    <!-- 地面（草原） -->
    <a-plane position="0 0 0" rotation="-90 0 0" width="30" height="30" 
             material="color: #228B22; roughness: 1"></a-plane>

    <!-- 森の木々 -->
    <!-- 大きな木1 -->
    <a-entity position="-8 0 -8">
      <a-cylinder radius="0.8" height="6" color="#8B4513" position="0 3 0"></a-cylinder>
      <a-sphere radius="3.5" color="#228B22" position="0 7 0"></a-sphere>
    </a-entity>
    
    <!-- 大きな木2 -->
    <a-entity position="12 0 -10">
      <a-cylinder radius="1" height="8" color="#8B4513" position="0 4 0"></a-cylinder>
      <a-sphere radius="4" color="#228B22" position="0 9 0"></a-sphere>
    </a-entity>
    
    <!-- 大きな木3 -->
    <a-entity position="-15 0 5">
      <a-cylinder radius="1.2" height="7" color="#8B4513" position="0 3.5 0"></a-cylinder>
      <a-sphere radius="4.5" color="#228B22" position="0 8.5 0"></a-sphere>
    </a-entity>

    <!-- 中くらいの木々 -->
    <a-entity position="8 0 8">
      <a-cylinder radius="0.6" height="4" color="#8B4513" position="0 2 0"></a-cylinder>
      <a-sphere radius="2.5" color="#2F4F2F" position="0 5 0"></a-sphere>
    </a-entity>
    
    <a-entity position="-5 0 10">
      <a-cylinder radius="0.5" height="3.5" color="#8B4513" position="0 1.75 0"></a-cylinder>
      <a-sphere radius="2" color="#228B22" position="0 4.2 0"></a-sphere>
    </a-entity>

    <!-- 茂みと花 -->
    <a-sphere position="4 0.8 5" radius="1.5" color="#228B22"></a-sphere>
    <a-sphere position="-3 0.6 -3" radius="1.2" color="#2F4F2F"></a-sphere>
    <a-sphere position="7 0.7 -2" radius="1.3" color="#228B22"></a-sphere>
    
    <!-- 花 -->
    <a-entity position="3 0 2">
      <a-cylinder radius="0.05" height="0.8" color="#90EE90" position="0 0.4 0"></a-cylinder>
      <a-sphere radius="0.25" color="#FF69B4" position="0 0.9 0"></a-sphere>
    </a-entity>
    
    <a-entity position="-2 0 4">
      <a-cylinder radius="0.04" height="0.6" color="#90EE90" position="0 0.3 0"></a-cylinder>
      <a-sphere radius="0.2" color="#FFB6C1" position="0 0.7 0"></a-sphere>
    </a-entity>

    <!-- カメラ（fuseカーソル + レイキャスター） -->
    <a-entity id="rig" position="0 1.6 3">
      <a-camera wasd-controls>
        <a-cursor
          fuse="true"
          fuse-timeout="1000"
          raycaster="objects: .star"
          material="color: #FFD700; shader: flat"
          geometry="radiusInner: 0.02; radiusOuter: 0.03"
        ></a-cursor>

        <!-- サウンド：カメラの子にして non-positional で確実に聞こえる -->
        <a-entity id="sfx" sound="src: #star-sound; positional: false; volume: 0.7"></a-entity>
      </a-camera>
    </a-entity>

    <!-- スコアUI -->
    <a-entity id="ui" position="0 2.8 -1.5">
      <a-plane width="2" height="0.6" color="#228B22" material="opacity: 0.9" position="0 0 0"></a-plane>
      <a-entity id="score" text="value: 0 / 5; color: white; align: center; width: 4" position="0 0 0.01"></a-entity>
    </a-entity>

    <!-- おめでとうUI -->
    <a-entity id="congrats" visible="false" position="0 2.2 -1.8">
      <a-plane width="3" height="1.5" color="#FFD700" material="opacity: 0.95" position="0 0 0"></a-plane>
      <a-entity text="value: 🎉 おめでとう！; color: #333; align: center; width: 5" position="0 0.4 0.01"></a-entity>
      <a-entity text="value: すべての星を見つけたね！; color: #333; align: center; width: 4" position="0 0.1 0.01"></a-entity>
      <a-entity text="value: もう一度遊ぶ; color: #333; align: center; width: 3" position="0 -0.2 0.01"></a-entity>
      <a-plane id="restartBtn" class="ui-btn" position="0 -0.5 0.02" width="1.5" height="0.4" color="#228B22"></a-plane>
    </a-entity>

    <!-- 星の生成先 -->
    <a-entity id="stars-container"></a-entity>

    <!-- 雲 -->
    <a-sphere position="20 12 -15" radius="3" color="#FFFFFF" opacity="0.8"></a-sphere>
    <a-sphere position="-25 14 -10" radius="2.5" color="#FFFFFF" opacity="0.8"></a-sphere>

    <script>
      // ===== 設定 =====
      const TOTAL_STARS = 5;
      let foundStars = 0;

      // VRモード関数
      function enterVRMode() {
        const scene = document.querySelector('a-scene');
        if (scene && scene.enterVR) {
          scene.enterVR();
        } else {
          // A-FrameのVRボタンを探してクリック
          const vrButton = document.querySelector('.a-enter-vr-button');
          if (vrButton) {
            vrButton.click();
          } else {
            alert('VRヘッドセットが検出されていません。PCモードでお楽しみください！');
          }
        }
      }

      // 星の収集コンポーネント
      AFRAME.registerComponent('star-collectible', {
        schema: { index: { type: 'int' } },
        init: function () {
          const el = this.el;

          // ホバーアニメーション
          el.setAttribute('animation__hover', 
            'property: scale; startEvents: mouseenter; to: 1.3 1.3 1.3; dur: 200; easing: easeOutQuad');
          el.setAttribute('animation__unhover', 
            'property: scale; startEvents: mouseleave; to: 1 1 1; dur: 200; easing: easeOutQuad');

          // クリックイベント
          el.addEventListener('click', () => {
            if (!el.getAttribute('visible')) return;

            // サウンド再生
            const sfx = document.querySelector('#sfx');
            if (sfx && sfx.components && sfx.components.sound) {
              try { 
                sfx.components.sound.stopSound(); 
                sfx.components.sound.playSound(); 
              } catch(e) {
                console.log('音声再生エラー:', e);
              }
            }

            // 星が消えるアニメーション
            el.setAttribute('animation__collect', {
              property: 'scale', 
              to: '0.01 0.01 0.01', 
              dur: 300, 
              easing: 'easeInQuad'
            });
            
            el.setAttribute('animation__glow', {
              property: 'material.emissiveIntensity', 
              to: 2, 
              dur: 150, 
              easing: 'easeOutQuad'
            });

            setTimeout(() => {
              el.setAttribute('visible', false);
              updateScore();
            }, 320);
          });
        }
      });

      // スコア更新
      function updateScore() {
        foundStars += 1;
        const score = document.querySelector('#score');
        if (score) {
          score.setAttribute('text', 'value', `${foundStars} / ${TOTAL_STARS}`);
        }

        if (foundStars >= TOTAL_STARS) {
          setTimeout(() => {
            const ui = document.querySelector('#ui');
            const congrats = document.querySelector('#congrats');
            if (ui) ui.setAttribute('visible', false);
            if (congrats) {
              congrats.setAttribute('visible', true);
              congrats.setAttribute('animation__pop', 
                'property: scale; from: 0.5 0.5 0.5; to: 1 1 1; dur: 400; easing: easeOutBack');
            }
          }, 300);
        }
      }

      // リスタート機能
      document.addEventListener('DOMContentLoaded', () => {
        const btn = document.querySelector('#restartBtn');
        if (btn) {
          btn.addEventListener('click', restartGame);
        }
      });

      function restartGame() {
        foundStars = 0;
        const score = document.querySelector('#score');
        if (score) score.setAttribute('text', 'value', `${foundStars} / ${TOTAL_STARS}`);
        
        const ui = document.querySelector('#ui');
        const congrats = document.querySelector('#congrats');
        if (ui) ui.setAttribute('visible', true);
        if (congrats) congrats.setAttribute('visible', false);

        clearStars();
        spawnStars();
      }

      function clearStars() {
        const container = document.querySelector('#stars-container');
        if (!container) return;
        while (container.firstChild) {
          container.removeChild(container.firstChild);
        }
      }

      // 星のランダム配置
      function spawnStars() {
        const container = document.querySelector('#stars-container');
        if (!container) return;

        const positions = [
          { x: -7, y: 4, z: -7 },
          { x: 4.5, y: 1.8, z: 5 },
          { x: -2.5, y: 1.2, z: 3.5 },
          { x: 11, y: 8, z: -9 },
          { x: 8, y: 2.5, z: 7.5 }
        ];

        positions.forEach((pos, i) => {
          const star = document.createElement('a-dodecahedron');
          star.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
          star.setAttribute('radius', '0.4');
          star.setAttribute('color', '#FFD700');
          star.setAttribute('material', 'metalness: 0.3; roughness: 0.2; emissive: #FFD700; emissiveIntensity: 0.5');
          star.setAttribute('animation', 'property: rotation; to: 0 360 0; loop: true; dur: 4000; easing: linear');
          star.setAttribute('star-collectible', `index: ${i}`);
          star.classList.add('star');

          container.appendChild(star);
        });
      }

      // A-Frameの初期化を待ってゲーム開始
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(() => {
          spawnStars();
        }, 1000);
      });
    </script>
  </a-scene>
</body>
</html>
